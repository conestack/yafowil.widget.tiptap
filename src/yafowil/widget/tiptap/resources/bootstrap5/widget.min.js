var yafowil_tiptap=function(t,e,i){"use strict";class s{constructor(t,i={}){this.editor=t,this.editor_elem=e(t.options.element),this.opts=i,this.compile(i),this.container_elem=i.container_elem,this.on_click=this.on_click.bind(this),this.elem.on("click",this.on_click)}compile(t){this.container=e("<div />").addClass("action").appendTo(t.container_elem),this.elem=e("<div />").appendTo(this.container),t.tooltip&&(this.container.attr("data-bs-toggle","tooltip").attr("data-bs-title",t.tooltip),this.tooltip=new i.Tooltip(this.container)),t.icon&&(this.icon=e("<i />").addClass(`bi-${t.icon}`).appendTo(this.elem)),t.text&&e("<span />").text(t.text).appendTo(this.elem),t.css&&e("> *",this.elem).css(t.css),this.content=e("> *",this.elem)}get active(){return this._active}set active(t){this.opts.toggle&&(t?this.elem.addClass("active"):this.elem.removeClass("active")),this._active=t}on_click(t){t.preventDefault()}unload(){this.tooltip&&this.tooltip._element&&this.tooltip.dispose(),this.elem.off()}}class o extends s{compile(t){super.compile(t),this.container.addClass("btn-group"),this.elem.attr("role","button").addClass("btn btn-outline-secondary d-flex align-items-center")}}class n extends o{constructor(t,i={}){super(t,i),this.elem.addClass("drop_btn dropdown-toggle").attr("data-bs-toggle","dropdown"),this.dd_elem=e("<ul />").addClass("dropdown-menu tiptap-dropdown").appendTo(this.container),this.children=[],i.submit&&(this.dd_elem.addClass("p-3"),this.submit_elem=e("<button />").addClass("btn btn-secondary submit").text("submit").appendTo(this.dd_elem),this.submit=this.submit.bind(this),this.submit_elem.on("click",this.submit)),this.on_resize=this.on_resize.bind(this),e(window).on("resize",this.on_resize)}get active_item(){return this._active_item}set active_item(t){let e=t.elem.children().clone();this.elem.empty().append(e),this.content&&this.elem.prepend(this.content),this._active_item=t}unload(){e(window).off("resize",this.on_resize),this.submit_elem&&this.submit_elem.off();for(let t of this.children)t.unload();super.unload()}on_resize(t){this.active=!1}set_items(){for(let t of this.children)t.container.addClass("dropdown-item"),t.elem.on("click",(e=>{this.active_item=t}));this.active_item=this.children[0]}on_update(){}submit(t){t.preventDefault()}}class a extends o{static extensions=[tiptap.Bold];constructor(t,e,i){super(e,{container_elem:i.container_elem,icon:"type-bold",tooltip:"Toggle Bold",toggle:!0}),this.id="bold"}on_click(t){t.preventDefault(),this.active=!this.active,this.editor.chain().focus().toggleBold().run()}on_selection_update(){this.active=this.editor.isActive("bold")}}class l extends o{static extensions=[tiptap.Italic];constructor(t,e,i){super(e,{container_elem:i.container_elem,icon:"type-italic",tooltip:"Toggle Italic",toggle:!0}),this.id="italic"}on_click(t){t.preventDefault(),this.active=!this.active,this.editor.chain().focus().toggleItalic().run()}on_selection_update(){this.active=this.editor.isActive("italic")}}class r extends o{static extensions=[tiptap.Underline];constructor(t,e,i){super(e,{container_elem:i.container_elem,icon:"type-underline",tooltip:"Toggle Underline",toggle:!0}),this.id="underline"}on_click(t){t.preventDefault(),this.active=!this.active,this.editor.chain().focus().toggleUnderline().run()}on_selection_update(){this.active=this.editor.isActive("underline")}}class c extends o{static extensions=[tiptap.BulletList,tiptap.ListItem];constructor(t,e,i){super(e,{container_elem:i.container_elem,icon:"list-ul",tooltip:"Bullet List",toggle:!0}),this.id="bulletList",this.widget=t}on_click(t){t.preventDefault(),this.active=!this.active,this.editor.chain().focus().toggleBulletList().run()}on_update(){this.editor.isActive("orderedList")&&(this.active=!1)}on_selection_update(){this.active=this.editor.isActive("bulletList")}}class d extends o{static extensions=[tiptap.OrderedList,tiptap.ListItem];constructor(t,e,i){super(e,{container_elem:i.container_elem,icon:"list-ol",tooltip:"Ordered List",toggle:!0}),this.id="orderedList"}on_click(t){t.preventDefault(),this.active=!this.active,this.editor.chain().focus().toggleOrderedList().run()}on_update(){this.editor.isActive("bulletList")&&(this.active=!1)}on_selection_update(){this.active=this.editor.isActive("orderedList")}}class h extends o{static extensions=[tiptap.Blockquote];constructor(t,e,i){super(e,{container_elem:i.container_elem,icon:"text-indent-left",tooltip:"Indent"}),this.id="indent"}on_click(t){t.preventDefault(),this.editor.can().setBlockquote()&&this.editor.chain().focus().setBlockquote().run()}}class p extends o{static extensions=[tiptap.Blockquote];constructor(t,e,i){super(e,{container_elem:i.container_elem,icon:"text-indent-right",tooltip:"Outdent"}),this.id="outdent"}on_click(t){t.preventDefault(),this.editor.can().unsetBlockquote()&&this.editor.chain().focus().unsetBlockquote().run()}}class u extends s{static extensions=[tiptap.Heading];constructor(t,e,i){super(e,{container_elem:i.container_elem,text:`Heading ${i.level}`}),this.id="heading",this.level=i.level}on_click(t){t.preventDefault(),this.editor.chain().focus().toggleHeading({level:this.level}).run()}}class _ extends s{constructor(t,e,i){super(e,{container_elem:i.container_elem,text:"Text"}),this.id="paragraph"}on_click(t){t.preventDefault(),this.editor.chain().focus().setParagraph().run()}}class m extends s{constructor(t,i,s){super(i,{container_elem:s.container_elem,text:s.swatch.name}),this.id="color",this.swatch=s.swatch,e("<div />").addClass("color border").css("background-color",this.swatch.color).prependTo(this.elem)}on_click(t){t.preventDefault(),this.editor.chain().focus().setColor(this.swatch.color).run()}}class v extends s{constructor(t,i,s){super(i,{container_elem:s.container_elem,text:"None"}),this.id="unsetColor",e("<div />").addClass("color border").css("background-color","rgb(51, 51, 51)").prependTo(this.elem)}on_click(t){t.preventDefault(),this.editor.chain().focus().unsetColor().run()}}class f extends n{static extensions=[tiptap.Heading];constructor(t,e,i){super(e,{container_elem:i.container_elem,icon:"fonts"}),this.id="headings",this.children.push(new _(t,e,{container_elem:this.dd_elem}));for(let i=1;i<=6;i++)this.children.push(new u(t,e,{container_elem:this.dd_elem,level:i}));this.set_items()}reset(){this.active_item=this.children[0]}on_selection_update(){if(this.editor.isActive("paragraph"))this.active_item=this.children[0];else for(let t=1;t<=6;t++)this.editor.isActive("heading",{level:t})&&(this.active_item=this.children[t])}}class g extends n{static extensions=[tiptap.Color];constructor(t,e,i){super(e,{container_elem:i.container_elem}),this.id="colors",this.children.push(new v(t,e,{container_elem:this.dd_elem})),this.colors=t.colors;for(let i of this.colors)this.children.push(new m(t,e,{container_elem:this.dd_elem,swatch:i}));this.set_items()}on_selection_update(){for(let t of this.colors){let e=this.colors.indexOf(t);if(this.editor.isActive("textStyle",{color:t.color}))return void(this.active_item=this.children[e+1])}this.editor.isActive("textStyle",{color:/.*/})||(this.active_item=this.children[0])}}class x extends n{static extensions=[tiptap.Image];constructor(t,i,s){super(i,{container_elem:s.container_elem,tooltip:"Add Image",icon:"image",submit:!0}),this.id="image",this.src_elem=e("<div />").addClass("input-group input-group-sm mb-2").append(e("<span />").addClass("input-group-text name").text("src:")).append(e('<input type="text" />').addClass("form-control")).prependTo(this.dd_elem),this.alt_elem=e("<div />").addClass("input-group input-group-sm mb-2").append(e("<span />").addClass("input-group-text name").text("alt:")).append(e('<input type="text" />').addClass("form-control")).prependTo(this.dd_elem),this.title_elem=e("<div />").addClass("input-group input-group-sm mb-2").append(e("<span />").addClass("input-group-text name").text("title:")).append(e('<input type="text" />').addClass("form-control")).prependTo(this.dd_elem)}submit(t){t.preventDefault(),this.editor.chain().focus().setImage({src:e("input",this.src_elem).val(),alt:e("input",this.alt_elem).val(),title:e("input",this.title_elem).val()}).run(),this.dd_elem.hide()}}class b extends n{static extensions=[tiptap.Link];constructor(t,i,s){super(i,{container_elem:s.container_elem,tooltip:"Add Link",icon:"link-45deg",submit:!0}),this.id="link",this.href_elem=e("<div />").addClass("input-group input-group-sm mb-2").append(e("<span />").addClass("input-group-text name").text("href:")).append(e('<input type="text" />').addClass("form-control")).prependTo(this.dd_elem)}submit(t){t.preventDefault();let i=e("input",this.href_elem).val();this.editor.chain().focus().setLink({href:i}).run(),this.dd_elem.hide()}}class w extends o{static extensions=[tiptap.Code];constructor(t,e,i){super(e,{container_elem:i.container_elem,icon:"code-slash",tooltip:"Toggle Code",toggle:!0}),this.widget=t,this.id="code"}on_click(t){t.preventDefault(),this.active=!this.active,this.editor.chain().focus().toggleCode().run()}on_selection_update(){this.active=this.editor.isActive("code")}}class k extends o{static extensions=[tiptap.CodeBlock];constructor(t,e,i){super(e,{container_elem:i.container_elem,icon:"braces",tooltip:"Toggle Code Block",toggle:!0}),this.id="codeBlock"}on_click(t){t.preventDefault(),this.active=!this.active,this.editor.chain().focus().toggleCodeBlock().run()}on_selection_update(){this.active=this.editor.isActive("codeBlock")}}let C={bold:a,italic:l,underline:r,bulletList:c,orderedList:d,indent:h,outdent:p,html:class extends o{static extensions=[];constructor(t,e,i){super(e,{container_elem:i.container_elem,icon:"pencil",tooltip:"Edit HTML",toggle:!0}),this.id="html",this.widget=t,this.textarea=this.widget.textarea}on_click(t){t.preventDefault(),this.active=!this.active;for(let t in this.widget.buttons){if(t===this.id)continue;const e=this.widget.buttons[t];this.active?e.elem.addClass("disabled"):e.elem.removeClass("disabled")}this.active?(this.widget.editarea.hide(),this.textarea.show()):(this.textarea.hide(),this.widget.editarea.show(),this.editor.chain().focus().setContent(this.textarea.val()).run())}},heading:f,color:g,image:x,link:b,code:w,codeBlock:k,helpLink:class{static extensions=[];constructor(t){this.elem=e("<a />").attr("href","https://tiptap.dev/api/keyboard-shortcuts#predefined-keyboard-shortcuts").attr("target","_blank").attr("data-bs-toggle","tooltip").attr("data-bs-title","Help").addClass("help-btn").append(e("<div />").text("?")).insertAfter(t.elem),new i.Tooltip(this.container)}}};class y{static initialize(t){e("div.tiptap-editor",t).each((function(){let t=e(this);void 0!==window.yafowil_array&&window.yafowil_array.inside_template(t)||new y(t,{actions:t.data("tiptap-actions"),colors:t.data("tiptap-colors"),helpLink:t.data("tiptap-helpLink")})}))}constructor(t,i={}){if(t.data("yafowil-tiptap",this),t.attr("spellcheck",!1),this.elem=t,this.controls=e("<div />").addClass("tiptap-controls btn-toolbar mb-2").attr("role","toolbar").prependTo(t),this.textarea=e("textarea",t),this.textarea.length||(this.textarea=e("<textarea />").addClass("tiptap-editor").appendTo(t)),this.textarea.addClass("m-0 form-control"),this.buttons={},this.colors=i.colors,i.helpLink){let t=C.helpLink;this.helpLink=new t(this)}let s=this.parse_actions(i.actions),o=this.parse_extensions(s);this.editor=new tiptap.Editor({element:t[0],extensions:o,content:this.textarea.val()}),this.editarea=e("div.ProseMirror",this.elem).addClass("form-control"),s.forEach((t=>{if(Array.isArray(t)){let i=e("<div />").addClass("btn-group me-2").appendTo(this.controls);t.forEach((t=>this.add_button(t,i)))}else this.add_button(t,this.controls)})),this.on_update=this.on_update.bind(this),this.editor.on("update",this.on_update),this.on_selection_update=this.on_selection_update.bind(this),this.editor.on("selectionUpdate",this.on_selection_update),void 0!==window.ts&&ts.ajax.attach(this,t)}destroy(){this.editor&&(this.editor.off(),this.editor.destroy()),this.unload_all(),this.helpLink&&"function"==typeof this.helpLink.unload&&this.helpLink.unload(),this.elem.removeData("yafowil-tiptap"),this.editarea.off(),this.controls.off(),this.textarea.off(),this.elem.off()}unload_all(){for(let t in this.buttons)this.buttons[t].unload()}add_button(t,e){let i=new(0,C[t])(this,this.editor,{container_elem:e});this.buttons[t]=i}parse_actions(t){let e=[];return function t(i,s){s.forEach(((s,o)=>{Array.isArray(s)?(e.push([]),t(e[e.length-1],s)):null==C[s]?console.log(`ERROR: Defined action does not exist at '${s}'`):i.push(s)}))}(e,t),e}parse_extensions(t){let e=new Set([tiptap.Document,tiptap.Paragraph,tiptap.Text,tiptap.TextStyle,tiptap.Dropcursor]);return t.flat(2).forEach((t=>{C[t].extensions.forEach((t=>e.add(t)))})),e}on_update(){for(let t in this.buttons)this.buttons[t].on_update&&this.buttons[t].on_update();this.textarea.val(this.editor.getHTML())}on_selection_update(){for(let t in this.buttons)this.buttons[t].on_selection_update&&this.buttons[t].on_selection_update()}}function L(t,e){y.initialize(e)}function T(){void 0!==window.yafowil_array&&window.yafowil_array.on_array_event("on_add",L)}return e((function(){void 0!==window.ts?ts.ajax.register(y.initialize,!0):void 0!==window.bdajax?bdajax.register(y.initialize,!0):y.initialize(),T()})),t.TiptapWidget=y,t.register_array_subscribers=T,Object.defineProperty(t,"__esModule",{value:!0}),window.yafowil=window.yafowil||{},window.yafowil.tiptap=t,t}({},jQuery,bootstrap);
